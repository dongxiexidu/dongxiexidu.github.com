---
layout: post
title: iOS之静态库和动态库
date: 2015-02-05
tags: 性能
---


### 一.什么是库 ?
库就是程序代码的集合，将N个文件组织起来，是共享程序代码的一种方式。**库从本质上来说是一种可执行代码的二进制格式，可以被载入内存中执行**。

### 二.库的分类
- 1.开源库：源代码是公开的，可以看到每个实现文件（.m文件）的实现，例如GitHub上的常用的开源库：AFNetworking、SDWebImage等
- 2.闭源库：不公开源代码，是经过编译后的二进制文件，看不到具体的实现。闭源库又分为：静态库 和 动态库

### 三.iOS开发中静态库和动态库区别:
**静态库和动态库是相对编译期和运行期的**:静态库在程序编译时会被链接到目标代码中，程序运行时将不再需要改静态库；

而动态库在程序编译时并不会被链接到目标代码中，只是在程序运行时才被载入，因为在程序运行期间还需要动态库的存在.

说白了,静态库是编译期间就会被链接到目标代码中,动态库是程序运行时才被载入

#### 静态库 好处：
- 1.核心技术的保密
- 2.模块化，分工合作，提高了代码的复用

#### 动态库 好处：
- 1.可以将最终可执行文件体积缩小，将整个应用程序分模块，团队合作，进行分工，影响比较小
- 2.多个应用程序共享内存中得同一份库文件，节省资源
- 3.可以不重新编译连接可执行程序的前提下，更新动态库文件达到更新应用程序的目的
- 4.应用插件化

>在其它大部分平台上，动态库都可以用于不同应用间共享， 共享可执行文件，这就大大节省了内存。
iOS平台 在 iOS8 之前，苹果不允许第三方框架使用动态方式加载，从 iOS8 开始允许开发者有条件地创建和使用动态框架，这种框架叫做 Cocoa Touch Framework。虽然同样是动态框架，但是和系统 framework 不同，app 中使用 Cocoa Touch Framework 制作的动态库 在打包和提交 app 时会被放到 app main bundle 的根目录 中，运行在沙盒里，而不是系统中。也就是说，不同的 app 就算使用了同样的 framework，但还是会有多份的框架被分别签名，打包和加载。不过 iOS8 上开放了 App Extension 功能，可以为一个应用创建插件，这样主app和插件之间共享动态库还是可行的。
苹果系统专属的framework 是共享的（如UIKit）, 但是我们自己使用 Cocoa Touch Framework 制作的动态库是放到 app bundle 中，运行在沙盒中的

### 四.静态库和动态库的存在的形式

- 静态库：以.a 和 .framework为文件后缀名
- 动态库：以.tbd(之前叫.dylib) 和 .framework 为文件后缀名。（系统直接提供给我们的framework都是动态库！）

理解：.a 是一个纯二进制文件，.framework 中除了有二进制文件之外还有资源文件。 .a ，要有 .h 文件以及资源文件配合， .framework 文件可以直接使用。总的来说，.a + .h + sourceFile = .framework。所以创建静态库最好还是用.framework的形式

### 五.静态库和动态库的区别

#### 不同点：
- 1.静态库在链接时，会被完整的复制到可执行文件中，如果多个App都使用了同一个静态库，那么每个App都会拷贝一份，缺点是浪费内存。类似于定义一个基本变量，使用该基本变量是是新复制了一份数据，而不是原来定义的；
- 2.动态库不会复制，只有一份，程序运行时动态加载到内存中，系统只会加载一次，多个程序共用一份，节约了内存。类似于使用变量的内存地址一样，使用的是同一个变量；

#### 共同点：

静态库和动态库都是闭源库，只能拿来满足某个功能的使用，不会暴露内部具体的代码信息

### 动态库动态更新问题
能否动态库的方式来动态更新AppStore上的版本呢？

framework本来是苹果专属的内部提供的动态库文件格式，但是自从2014年WWDC之后，开发者也可以自定义创建framework实现动态更新（绕过apple store审核，从服务器发布更新版本）的功能，这与苹果限定的上架的app必须经过apple store的审核制度是冲突的，所以含有自定义的framework的app是无法在商店上架的，但是如果开发的是企业内部应用，就可以考虑尝试使用动态更新技术来将多个独立的app或者功能模块集成在一个app上面！（我开发的就是企业内部使用的app，我们将企业官网中的板块开发成4个独立的app，然后将其改造为framework文件最终集成在一款平台级的app当中进行使用，这样就可以在一款app上面使用原本4个app的全部功能！）

使用自定义的动态库的方式来动态更新只能用在 in house(企业发布) 和develop 模式却但不能在使用到 AppStore 因为在上传打包的时候，苹果会对我们的代码进行一次 Code Singing，包括 app 可执行文件和所有Embedded 的动态库。因此，只要你修改了某个动态库的代码，并重新签名，那么 MD5 的哈希值就会不一样，在加载动态库的时候，苹果会检验这个 hash 值，当苹果监测到这个动态库非法时，就会造成 Crash
